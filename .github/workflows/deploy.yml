name: Deploy Laravel React App

on:
  push:
    branches:
      - main
      - dev

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '18'

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: Deploy to Production
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, openssl, pdo, pdo_mysql, tokenizer, xml, ctype, json, fileinfo

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node.js dependencies
        run: npm ci --force

      - name: Build assets
        run: npm run build

      - name: Prepare for deployment
        run: |
          # Remove development files
          rm -rf node_modules
          rm -f .env.example
          rm -rf tests
          rm -f phpunit.xml
          
          # Create .env if it doesn't exist (for first deployment)
          if [ ! -f ".env" ]; then
            cp .env.example .env
          fi

      - name: Deploy to Production via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Direct deployment directory
            DEPLOY_DIR="/var/www/optimalcomfy"
            
            echo "ğŸš€ Deploying to: $DEPLOY_DIR"
            
            # Create directory if it doesn't exist
            mkdir -p $DEPLOY_DIR
            
            # Clean the directory (keep .env if exists)
            if [ -f "$DEPLOY_DIR/.env" ]; then
              echo "ğŸ’¾ Preserving existing .env file..."
              BACKUP_ENV="/tmp/.env.backup"
              cp $DEPLOY_DIR/.env $BACKUP_ENV
            fi
            
            # Remove all contents except storage if exists
            if [ -d "$DEPLOY_DIR/storage" ]; then
              echo "ğŸ’¾ Preserving storage directory..."
              BACKUP_STORAGE="/tmp/storage.backup"
              cp -r $DEPLOY_DIR/storage $BACKUP_STORAGE
            fi
            
            # Clean target directory
            rm -rf $DEPLOY_DIR/*
            
            # Restore .env if it existed
            if [ -f "$BACKUP_ENV" ]; then
              cp $BACKUP_ENV $DEPLOY_DIR/.env
              rm -f $BACKUP_ENV
            fi
            
            # Restore storage if it existed
            if [ -d "$BACKUP_STORAGE" ]; then
              cp -r $BACKUP_STORAGE/* $DEPLOY_DIR/storage/ 2>/dev/null || true
              rm -rf $BACKUP_STORAGE
            fi
            
            echo "ğŸ“¦ Copying files..."
            # Copy all files from GitHub
            tar -cf - --exclude='.git' --exclude='node_modules' . | ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "cd $DEPLOY_DIR && tar -xf -"
            
            echo "ğŸ” Setting permissions..."
            chown -R www-data:www-data $DEPLOY_DIR
            chmod -R 755 $DEPLOY_DIR
            chmod -R 775 $DEPLOY_DIR/storage
            chmod -R 775 $DEPLOY_DIR/bootstrap/cache
            
            echo "ğŸ“¦ Installing dependencies..."
            cd $DEPLOY_DIR
            composer install --no-dev --optimize-autoloader --no-interaction
            npm ci --only=production --force
            
            echo "ğŸ”— Creating storage symlink..."
            rm -f public/storage
            php artisan storage:link
            
            echo "ğŸ§¹ Clearing caches..."
            php artisan optimize:clear
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "ğŸ”„ Restarting services..."
            sudo systemctl reload php8.4-fpm
            sudo systemctl reload nginx
            
            echo "âœ… Production deployment completed!"
            echo "ğŸ“ Deployed to: $DEPLOY_DIR"

  deploy-test:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    name: Deploy to Test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, bcmath, openssl, pdo, pdo_mysql, tokenizer, xml, ctype, json, fileinfo

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node.js dependencies
        run: npm ci --force

      - name: Build assets
        run: npm run build

      - name: Prepare for deployment
        run: |
          # Remove development files
          rm -rf node_modules
          rm -rf tests
          rm -f phpunit.xml
          
          # Create test .env if it doesn't exist
          if [ ! -f ".env" ]; then
            cat > .env << 'EOF'
          APP_NAME="OptimalComfy Test"
          APP_ENV=testing
          APP_KEY=
          APP_DEBUG=true
          APP_URL=http://your-test-domain.com

          DB_CONNECTION=mysql
          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=optimalcomfy_test
          DB_USERNAME=root
          DB_PASSWORD="your-test-password"
          EOF
          fi

      - name: Deploy to Test via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Direct deployment directory
            DEPLOY_DIR="/var/www/optimalcomfy-test"
            
            echo "ğŸš€ Deploying to: $DEPLOY_DIR"
            
            # Create directory if it doesn't exist
            mkdir -p $DEPLOY_DIR
            
            # Clean the directory (keep .env if exists)
            if [ -f "$DEPLOY_DIR/.env" ]; then
              echo "ğŸ’¾ Preserving existing .env file..."
              BACKUP_ENV="/tmp/.env.test.backup"
              cp $DEPLOY_DIR/.env $BACKUP_ENV
            fi
            
            # Remove all contents except storage if exists
            if [ -d "$DEPLOY_DIR/storage" ]; then
              echo "ğŸ’¾ Preserving storage directory..."
              BACKUP_STORAGE="/tmp/storage.test.backup"
              cp -r $DEPLOY_DIR/storage $BACKUP_STORAGE
            fi
            
            # Clean target directory
            rm -rf $DEPLOY_DIR/*
            
            # Restore .env if it existed
            if [ -f "$BACKUP_ENV" ]; then
              cp $BACKUP_ENV $DEPLOY_DIR/.env
              rm -f $BACKUP_ENV
            fi
            
            # Restore storage if it existed
            if [ -d "$BACKUP_STORAGE" ]; then
              cp -r $BACKUP_STORAGE/* $DEPLOY_DIR/storage/ 2>/dev/null || true
              rm -rf $BACKUP_STORAGE
            fi
            
            echo "ğŸ“¦ Copying files..."
            # Copy all files from GitHub
            tar -cf - --exclude='.git' --exclude='node_modules' . | ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "cd $DEPLOY_DIR && tar -xf -"
            
            echo "ğŸ” Setting permissions..."
            chown -R www-data:www-data $DEPLOY_DIR
            chmod -R 755 $DEPLOY_DIR
            chmod -R 775 $DEPLOY_DIR/storage
            chmod -R 775 $DEPLOY_DIR/bootstrap/cache
            
            echo "ğŸ“¦ Installing dependencies..."
            cd $DEPLOY_DIR
            composer install --no-dev --optimize-autoloader --no-interaction
            npm ci --only=production --force
            
            # Generate app key if .env is new
            if [ ! -f "$DEPLOY_DIR/.env.backup" ]; then
              php artisan key:generate
            fi
            
            echo "ğŸ”— Creating storage symlink..."
            rm -f public/storage
            php artisan storage:link
            
            echo "ğŸ§¹ Clearing caches..."
            php artisan optimize:clear
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            
            echo "ğŸ”„ Restarting services..."
            sudo systemctl reload php8.4-fpm
            sudo systemctl reload nginx
            
            echo "âœ… Test deployment completed!"
            echo "ğŸ“ Deployed to: $DEPLOY_DIR"